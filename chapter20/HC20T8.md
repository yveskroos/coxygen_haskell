import Control.Applicative
import Data.Char

-- DÃ©finition du type Parser
newtype Parser a = Parser { runParser :: String -> [(a, String)] }

-- ImplÃ©mentation Functor
instance Functor Parser where
    fmap f (Parser p) = Parser $ \input ->
        [ (f a, rest) | (a, rest) <- p input ]

-- ImplÃ©mentation Applicative
instance Applicative Parser where
    pure a = Parser $ \input -> [(a, input)]
    (Parser pf) <*> (Parser pa) = Parser $ \input ->
        [ (f a, rest2) | (f, rest1) <- pf input, (a, rest2) <- pa rest1 ]

-- ImplÃ©mentation Monad
instance Monad Parser where
    (Parser pa) >>= f = Parser $ \input ->
        [ (b, rest2) | (a, rest1) <- pa input, (b, rest2) <- runParser (f a) rest1 ]

-- ImplÃ©mentation Alternative (choix)
instance Alternative Parser where
    empty = Parser $ \_ -> []
    (Parser p1) <|> (Parser p2) = Parser $ \input ->
        case p1 input of
            [] -> p2 input
            res -> res

-- ğŸ”¹ Primitives de parsing
item :: Parser Char
item = Parser $ \input ->
    case input of
        []     -> []
        (c:cs) -> [(c, cs)]

satisfy :: (Char -> Bool) -> Parser Char
satisfy pred = do
    c <- item
    if pred c then return c else empty

char :: Char -> Parser Char
char c = satisfy (== c)

digit :: Parser Char
digit = satisfy isDigit

spaces :: Parser ()
spaces = many (satisfy isSpace) >> return ()

number :: Parser Int
number = do
    spaces
    digits <- some digit
    return (read digits)

-- ğŸ”¹ Grammaire des expressions
-- expr   ::= term ('+' expr | Îµ)
-- term   ::= factor ('*' term | Îµ)
-- factor ::= number | '(' expr ')'

expr :: Parser Int
expr = do
    t <- term
    (do
        spaces
        char '+'
        e <- expr
        return (t + e)) <|> return t

term :: Parser Int
term = do
    f <- factor
    (do
        spaces
        char '*'
        t <- term
        return (f * t)) <|> return f

factor :: Parser Int
factor =
        number
    <|> do
        spaces
        char '('
        e <- expr
        spaces
        char ')'
        return e

-- ğŸ”¹ Exemple d'utilisation
main :: IO ()
main = do
    print $ runParser expr "2+3*4"      -- [(14,"")]
    print $ runParser expr "(2+3)*4"    -- [(20,"")]
    print $ runParser expr "42"         -- [(42,"")]
    print $ runParser expr "7+8+9"      -- [(24,"")]
