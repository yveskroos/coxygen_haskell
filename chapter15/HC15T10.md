-- HC15T10 : Programme de vitesse utilisant Either et exceptions IO

import System.IO
import Control.Exception (try, IOException)
import Text.Read (readMaybe)

-- Fonction de division sécurisée avec Either
safeDiv :: Double -> Double -> Either String Double
safeDiv _ 0 = Left " Erreur : division par zéro"
safeDiv d t = Right (d / t)

-- Lecture sécurisée d'un fichier et parsing en Double
readDoubleFromFile :: FilePath -> IO (Either String Double)
readDoubleFromFile path = do
    result <- try (readFile path) :: IO (Either IOException String)
    case result of
        Left err -> return $ Left (" Erreur IO sur " ++ path ++ " : " ++ show err)
        Right contenu ->
            case readMaybe (head (words contenu)) of
                Nothing -> return $ Left (" Erreur de parsing dans " ++ path)
                Just val -> return $ Right val

-- Programme principal
main :: IO ()
main = do
    putStrLn "=== Programme de calcul de vitesse (hybride IO + Either) ==="

    -- Lire distance et temps depuis des fichiers
    ed <- readDoubleFromFile "distance.txt"
    et <- readDoubleFromFile "temps.txt"

    -- Gestion des erreurs combinées
    case (ed, et) of
        (Right d, Right t) ->
            case safeDiv d t of
                Left errMsg -> putStrLn errMsg
                Right v     -> putStrLn $ " Vitesse calculée : " ++ show v ++ " m/s"
        (Left err, _) -> putStrLn err
        (_, Left err) -> putStrLn err

